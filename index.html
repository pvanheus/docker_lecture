<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Advanced Operating Systems: Docker</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/sky.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section><h2>Docker (and HPC)</h2>
				<p>Peter van Heusden (pvh@sanbi.ac.za) and <br /> Eugene de Beste, SANBI</p></section>
				<section>
					<h2>"The trick is to build a fast system" - Seymour Cray</h2>
				</section>
				<section><p>Reminder: High Performance Computing means optimising the <em>whole</em> computing system.</p>
				<p>Remember <strong>Amdahl's Law</strong>: the theoretical speedup of a task is always limited by the part of the task that cannot benefit from the improvement.</p>
			</section>
			<section>
				<p>"We should forget about small efficiencies, say about 97% of the time: premature optimization is the root of all evil." - Tony Hoare</p>
			</section>
			<section>
				<img style="width: 80%" src="images/gatk_germline.png" alt="Variant calling pipeline. Image source: https://github.com/common-workflow-language/workflows/tree/h3abionet-gatk-workflow/workflows/GATK" />
				<p class="fragment">Solve it in a way that is portable and can be adapted as software changes <span class="fragment">with a handful of developers</span></p>
			</section>
			<section>
				<pre>
					<code class="yaml">
class: Workflow
cwlVersion: v1.0

inputs:
  reference:
    type: File
    doc: reference human genome file

steps:

  create-dict:
    run: ../../tools/picard-CreateSequenceDictionary.cwl
    in:
      reference: reference
      outputFileName: output_RefDictionaryFile
      tmpdir: tmpdir
out: [ createDict_output ]
					</code>
				</pre>
				<p>From <a href="https://github.com/common-workflow-language/workflows/tree/h3abionet-gatk-workflow/workflows/GATK">CWL GATK workflow</a></p>
			</section>
			<section>
				<ul>
					<li>Virtualisation is a key tool in modern computing infrastructure for:</li>
					<ul>
						<li>Scalability</li>
						<li>Density (high utilisation)</li>
						<li>Security</li>
					</ul>
					<li class="fragment">Hypervisor based virtualisation achieves this at the cost of performance</li>
				</ul>
			</section>
			<section>
				<img style="width: 90%" src="images/hypervisors_and_containers.png" alt="Hypervisors vs Containers, original source unknown" />
			</section>
			<section>
				<ul>
					<li>Docker container isolation based on control groups (cgroups) and namespaces</li>
					<li class="fragment">Access to hardware is, in general, through same kernel interfaces as normal userspace code</li>
					<li class="fragment">Benefits from technology (e.g. Open vSwitch) designed to expose hardware virtualisation support</li>
					<li class="fragment">Device nodes can be exported to container (but: <strong>security?</strong>)</li>
				</ul>
			</section>
			<section>
				<pre><code class="bash" data-trim>
				pvh@gabber:~$ docker run hello-world
Unable to find image 'hello-world:latest' locally
latest: Pulling from library/hello-world

c04b14da8d14: Pull complete
Digest: sha256:0256e8a36e2070f7bf2d0b0763dbabdd67798512411de4cdcf9431a1feb60fd9
Status: Downloaded newer image for hello-world:latest

Hello from Docker!
				</code></pre>
			</section>
			<section>
				<p>Things to explore:
				<ul>
					<li class="fragment">Where are my processes?</li>
					<li class="fragment">Docker networking</li>
					<li class="fragment">Linux images: <em>ubuntu</em> and <em>alpine</em></li>
					<li class="fragment">Interactive containers <em>run -it</em></li>
				</ul>
			</section>
			<section>
				<ul>
					<li>Containers are built from images that themselves are built based on specification called Dockerfiles.</li>
					<li class="fragment">The <em>Dockerfile</em> constains commands and other specifications that describe how the image needs to be constructed.</li>
					<li class="fragment">Each Dockerfile is itself built off another <em>base image</em>, resulting in a <em>layered</em> approach that facilitates re-use.</li>
					<li class="fragment">Images can be hosted on Dockerhub or Quay.Io</li>
				</ul>
			</section>
			<section>
				<pre>
					<code data-trim>
FROM quay.io/refgenomics/docker-ubuntu:14.04

MAINTAINER Nik Krumm &lt;nkrumm@gmail.com&gt;

RUN git clone https://github.com/lh3/bwa && \
	cd bwa && \
	git checkout 0.7.10 &&  \
	make && cp bwa /usr/local/bin/bwa

RUN apt-get install -y samtools

# Convenience commands
ADD align.py /usr/local/bin/align.py
RUN chmod +x /usr/local/bin/align.py
RUN ln -s /usr/local/bin/align.py /usr/local/bin/align
CMD ["/usr/local/bin/align"]
					</code>
				</pre>
				<p>From: <a href="https://github.com/onecodex/docker-bwa">onecodex/docker-bwa</a></p>
			</section>

			<section>
				<h4>Docker images and repositories</h4>
				<p>Docker images are built using the <em>docker build</em> command
				with a reference to the path containing the Dockerfile. Images
			  can optionally be pushed to DockerHub using the <em>push</em>
			  command.</p>
				<pre>
					<code data-trim>
$ docker build -t pvanheus/aligntool:latest .

$ docker push pvanheus/aligntool:latest
					</code>
				</pre>
			</section>

			<section>
				<h4>The Quay.Io repository</h4>
				<p>The DockerHub is run by Docker, Inc. but alternative repositories
					exist, most notably <a href="https://quay.io">quay.io</a>. Quay is
					notable for having a powerful API and thus allowing for integration
					in automated workflows.</p>
					<p>It also supports Github integration.</p>
			</section>

			<section>
				<h4>Containers beyond Docker</h4>
				<ul>
					<li>Docker is by far the most popular container solution, however...</li>
					<li class="fragment">Concerns exist about Docker security and root escalation</li>
					<li class="fragment">Multi user environments like HPC clusters are loathe to install Docker</li>
					<li class="fragment">Thus: <em>Singularity</em> (and <em>Rocket</em>)</li>
				</ul>
			</section>

			<section>
				<h4>Singularity</h4>
				<ul>
					<li><a href="http://singularity.lbl.gov">Singularity</a> emerged out of Lawrence Berkeley Labs</li>
					<li class="fragment">Targetted at HPC community</li>
					<li class="fragment">Images are file based</li>
					<li class="fragment">Can build images from scratch or import from Docker</li>
					<li class="fragment">Minimises use of root</li>
					<li class="fragment">Run as user: no privileged operations</li>
			</section>

			<section>
				<h4>Assignment</h4>
				<ul>
					<li>Dockerize your own software</li>
					<li class="fragment">Either choose your Honours project or ask Peter for software</li>
					<li class="fragment">Write Dockerfile build image</li>
					<li class="fragment">Use EXPOSE for ports and VOLUME for volumes</li>
					<li class="fragment">Publish image on Docker Hub or Quay.Io</li>
					<li class="fragment">Convert your Docker image for use with Singularity</li>
					<li class="fragment">or explain why Singularity cannot be used for your project</li>
					<li class="fragment">Send README describing software and how to run it to Peter &lt;pvh@sanbi.ac.za&gt;</li>
				</ul>
			</section>
			<script src="lib/js/head.min.js"></script>
			<script src="js/reveal.js"></script>


			</div>
		</div>

		<script>
			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				history: true,

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
